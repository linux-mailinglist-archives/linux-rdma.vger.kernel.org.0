Return-Path: <linux-rdma+bounces-14960-lists+linux-rdma=lfdr.de@vger.kernel.org>
X-Original-To: lists+linux-rdma@lfdr.de
Delivered-To: lists+linux-rdma@lfdr.de
Received: from sto.lore.kernel.org (sto.lore.kernel.org [IPv6:2600:3c09:e001:a7::12fc:5321])
	by mail.lfdr.de (Postfix) with ESMTPS id F035ECB7048
	for <lists+linux-rdma@lfdr.de>; Thu, 11 Dec 2025 20:38:41 +0100 (CET)
Received: from smtp.subspace.kernel.org (conduit.subspace.kernel.org [100.90.174.1])
	by sto.lore.kernel.org (Postfix) with ESMTP id 6BBD43002142
	for <lists+linux-rdma@lfdr.de>; Thu, 11 Dec 2025 19:38:41 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 6A84A2C3257;
	Thu, 11 Dec 2025 19:38:40 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (3072-bit key) header.d=samba.org header.i=@samba.org header.b="GkPmW8dz"
X-Original-To: linux-rdma@vger.kernel.org
Received: from hr2.samba.org (hr2.samba.org [144.76.82.148])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id C6310281508;
	Thu, 11 Dec 2025 19:38:37 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=144.76.82.148
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1765481920; cv=none; b=pDw7I1NK03IRQaK5lCtl9YZs/nXoeErhNEijLbwlzHU1mRB1cgnjNbrUhHhHd8HzEw4+zSq7jlSt4+49Trv0Qi9yF73bR9qo64Fn53Cra1SXa3Mnha6qsSsgJx0um7O0n3n26W3oYb+J2dgffZC704wR2EfQMTU1LapVV7/ylfY=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1765481920; c=relaxed/simple;
	bh=VNEQaViSc7HQzpBLfK4KjjSt7RNitEzMmt7R8hRYEjc=;
	h=Message-ID:Date:MIME-Version:Subject:From:To:Cc:References:
	 In-Reply-To:Content-Type; b=qQcnph70ZRxwIxEyiHsEXjz9VBeDBQ1UOnG8d0Elz8oP2JN1xuswoF/u8TFnLzlmcPWnIi8RohNof5Oby1QHerJtqjilxIwUtS8NcVJc1yOf28blp/NyJpSoVBgnqoyTWFOdUi2zflYJAkot+zoRRy37GcrptgF/ZLNd0SEx8AI=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=samba.org; spf=pass smtp.mailfrom=samba.org; dkim=pass (3072-bit key) header.d=samba.org header.i=@samba.org header.b=GkPmW8dz; arc=none smtp.client-ip=144.76.82.148
Authentication-Results: smtp.subspace.kernel.org; dmarc=pass (p=quarantine dis=none) header.from=samba.org
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=samba.org
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=samba.org;
	s=42; h=Cc:To:From:Date:Message-ID;
	bh=xqdUuiLfCko2dH2H/SzZD5QI6OXn3iPafWwcV35BbrM=; b=GkPmW8dzNWKDj7K/8vtS5eD3HB
	SnlBqm7rlPA/HfGzFyw3eFkhfKuUlXtZbB5A3NQlWz70Ryi+wkj2SGFewibrk+oXpRo4YBUCpUXsq
	0kWHgPyrthmaOR0Nsjdt9BHR+DfTaJ9GkH70t4rjByHUn/VY836KPovaHdtgAj8u/CFZXRbNOm7qd
	qL0bldlJt07zRW3TZbSOaYFLtq/OqKLW+1Tgdd+0mhR41orbkRJO82fz791oW2rEilBzcEjwmTqz3
	B+8ouRq5RMq8JdaeGOrLKR+Dq253fh27YQl5YMuOCUBB0LP9+C7bmwOlAwh6bqmqkntPClD2O16Bv
	iYX8eAwWxNGf613xUZG1JuesLNynWWTQNW9IGzk51WQV5ntGmblqSTJS99YziS2L+p76FZYZDV2jw
	SsVHe0D+ZasYwBMWj/aI0Q6C6vh+fBtJjkGI7VwnaDSXYMEObiYD/AV+NcNaq7zF3kmK6FS1jG1VD
	ygrsCB8g3+5vmhpG2JFeQgKC;
Received: from [127.0.0.2] (localhost [127.0.0.1])
	by hr2.samba.org with esmtpsa (TLS1.3:ECDHE_SECP256R1__ECDSA_SECP256R1_SHA256__CHACHA20_POLY1305:256)
	(Exim)
	id 1vTmUf-000Ixy-2K;
	Thu, 11 Dec 2025 19:38:29 +0000
Message-ID: <a3760b26-7458-40a0-ae79-bb94dd0e1d01@samba.org>
Date: Thu, 11 Dec 2025 20:38:29 +0100
Precedence: bulk
X-Mailing-List: linux-rdma@vger.kernel.org
List-Id: <linux-rdma.vger.kernel.org>
List-Subscribe: <mailto:linux-rdma+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:linux-rdma+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
User-Agent: Mozilla Thunderbird
Subject: Re: Problem with smbdirect rw credits and initiator_depth
From: Stefan Metzmacher <metze@samba.org>
To: Namjae Jeon <linkinjeon@kernel.org>
Cc: Tom Talpey <tom@talpey.com>,
 "linux-cifs@vger.kernel.org" <linux-cifs@vger.kernel.org>,
 "linux-rdma@vger.kernel.org" <linux-rdma@vger.kernel.org>
References: <35eec2e6-bf37-43d6-a2d8-7a939a68021b@samba.org>
 <CAKYAXd9p=7BzmSSKi5n41OKkkw4qrr4cWpWet7rUfC+VT-6h1g@mail.gmail.com>
 <f59e0dc7-e91c-4a13-8d49-fe183c10b6f4@samba.org>
 <CAKYAXd-MF1j+CkbWakFJK2ov_SfRUXaRuT6jE0uHZoLxTu130Q@mail.gmail.com>
 <CAKYAXd__T=L9aWwOuY7Z8fJgMf404=KQ2dTpNRd3mq9dnYCxRw@mail.gmail.com>
 <86b3c222-d765-4a6c-bb79-915609fa3d27@samba.org>
Content-Language: en-US
In-Reply-To: <86b3c222-d765-4a6c-bb79-915609fa3d27@samba.org>
Content-Type: text/plain; charset=UTF-8; format=flowed
Content-Transfer-Encoding: 7bit

Am 10.12.25 um 17:42 schrieb Stefan Metzmacher:
> Am 05.12.25 um 13:21 schrieb Namjae Jeon:
>>>> Can you at least post the dmesg output generated by this:
>>>> https://git.samba.org/?p=metze/linux/wip.git;a=commitdiff;h=7e724ebc58e986f4e101a55f4ab5e96912239918
>>>> Assuming that this wasn't triggered:
>>>> if (WARN_ONCE(needed > max_possible, "needed:%u > max:%u\n", needed, max_possible))
>>> I didn't know you wanted it. I will share it after office.
>> I have attached v2 and v3 logs. Let me know if you need something more,
>>>>
>>>> Did you run the bpftrace command? Did it print a lot of
>>>> 'smb_direct_rdma_xmit' message over the whole time of the file copy?
>>> No, I didn't check it. but I will try this.
>> /mnt# bpftrace ksmbd-rdma-xmit.bt
>> Attaching 1 probe...
>>
>> The absence of any output after Attaching 1 probe... indicates that
>> the smb_direct_rdma_xmit function has not been called ?
> 
> Assuming the client requires signing, I may found the
> reason for a recv credit problem.
> 
> ksmbd uses this:
> 
> smb_direct_max_fragmented_recv_size = 1024 * 1024
> smb_direct_max_receive_size = 1364;
> smb_direct_receive_credit_max = 255;
> 
> In order for the client to fill the full eassembly buffer,
> all our recv buffers are moved into it, which means
> 255 * (1364 - 24) = 341700 (0x536C4) bytes of payload,
> after that we no longer able to grant and new recv credits to
> the peer, which tries to send up to 1048576 (0x100000).
> 
> I found this using smbclient to download a large file
> from a Windows server without using rdma offload.
> 
> So I guess you are seeing the problem when Windows
> tries to copy a file to ksmbd.
> 
> For smbclient I made it work by changing
> max_fragmented_recv_size to the minimum value of
> 131072 (0x20000), this value is smaller than
> all local recv buffers 255 * (1364 - 24) = 341700 (0x536C4).
>
> I try to find what difference we have between 6.17.9
> and 6.18 tomorrow.

The above is not a problem with 6.17.9 nor
with 6.18 in the server, as I found this logic
hiding in smb_direct_prepare().

         sp->max_fragmented_recv_size =
                 (sp->recv_credit_max * sp->max_recv_size) / 2;

It explains why I saw the strange 173910 value in captures...

But this is broken in the client as it doesn't
have this logic.

metze


